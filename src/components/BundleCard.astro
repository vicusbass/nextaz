---
import { Image } from 'astro:assets';
import rectangle from '../assets/shop/rectangle.svg';
import ConfigureBundleButton from './bundle/ConfigureBundleButton.svelte';
import type { BundleConfig } from '../types/cart';
import { urlFor } from '../utils/sanity';

interface WineDiscount {
  productId: string;
  productName: string;
  basePrice: number;
  discountPercent: number;
  image?: any;
}

interface Bundle {
  name: string;
  slug: { current: string };
  heroName: string;
  description: string;
  bottleCount: number;
  wineDiscounts: WineDiscount[];
}

interface Props {
  bundle: Bundle;
  icon?: ImageMetadata;
}

const { bundle, icon } = Astro.props;
const { name, description, bottleCount, slug, wineDiscounts } = bundle;

// Build BundleConfig for the configurator with image URLs
const bundleConfig: BundleConfig = {
  slug: slug.current,
  name,
  heroName: bundle.heroName,
  description,
  bottleCount,
  wineDiscounts: (wineDiscounts ?? []).map((w) => ({
    productId: w.productId,
    productName: w.productName,
    basePrice: w.basePrice,
    discountPercent: w.discountPercent,
    image: w.image ? (typeof w.image === 'string' ? w.image : urlFor(w.image)?.width(120).height(180).url()) : undefined,
  })),
};
---

<div class="flex flex-col py-12 lg:py-20" data-bundle-slug={slug.current}>
  <div
    class="flex h-[140px] w-full shrink-0 items-center justify-center gap-1 bg-transparent px-4 lg:h-[200px] lg:gap-2"
  >
    <div class="flex h-[70px] items-center lg:h-[100px]">
      {icon && <Image src={icon} alt="" class="h-full w-auto object-contain" aria-hidden="true" />}
      <Image
        src={rectangle}
        alt=""
        class="-ml-px h-full w-auto object-contain"
        aria-hidden="true"
      />
    </div>
    <p class="text-6xl font-bold text-black lg:text-8xl">
      {name.match(/\d+/)?.[0] || ''}
    </p>
  </div>

  <div
    class="flex flex-1 flex-col items-center justify-center gap-4 bg-white px-4 pt-8 text-center lg:gap-6 lg:px-6 lg:pt-12"
  >
    <div class="flex flex-col gap-2">
      <h3 class="text-lg leading-tight font-bold text-black lg:text-xl">
        {name}
      </h3>

      {description && <p class="text-gray text-sm leading-relaxed lg:text-base">{description}</p>}
    </div>

    <div class="flex flex-col items-center gap-4">
      <p class="text-sm text-gray lg:text-base">
        {bottleCount} sticle
      </p>

      <ConfigureBundleButton
        client:visible
        bundleConfig={bundleConfig}
      />
    </div>
  </div>
</div>
