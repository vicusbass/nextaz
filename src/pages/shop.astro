---
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets';
import heroImage from '../assets/shop/wine-hero.png';
import bronze from '../assets/shop/bronze.png';
import silver from '../assets/shop/silver.png';
import gold from '../assets/shop/gold.png';
import barrels from '../assets/shop/barrels.png';
import notebook from '../assets/shop/notebook.png';
import triangle from '../assets/shop/silver.png';
import { loadQuery } from '../utils/loadQuery';
import { shopQuery } from '../queries/shop';
import { urlFor } from '../utils/sanity';
import SingleProductCard from '../components/SingleProductCard.astro';
import PackageProductCard from '../components/PackageProductCard.astro';
import BundleCard from '../components/BundleCard.astro';
import BundleConfigurator from '../components/bundle/BundleConfigurator.svelte';
import AddToCartButton from '../components/cart/AddToCartButton.svelte';

interface Product {
  _id: string;
  name: string;
  slug: { current: string };
  productType: 'single' | 'package' | 'bundle';
  image: any;
  description: string;
  price: number;
}

interface WineDiscount {
  productId: string;
  productName: string;
  basePrice: number;
  discountPercent: number;
  image?: any;
}

interface Bundle {
  name: string;
  slug: { current: string };
  heroName: string;
  description: string;
  bottleCount: number;
  wineDiscounts: WineDiscount[];
}

interface Shop {
  title: string;
  products: Product[];
  bundles: Bundle[];
  customProductPrice: number;
  subscriptionPrice: number;
}

const { data: shop } = await loadQuery<Shop>({ query: shopQuery });
const products = shop?.products ?? [];
const bundles = shop?.bundles ?? [];
const customProductPrice = shop?.customProductPrice ?? 0;
const subscriptionPrice = shop?.subscriptionPrice ?? 0;

// Separate products by type
const singleProducts = products.filter((p) => p.productType === 'single');
const packages = products.filter((p) => p.productType === 'package' || p.productType === 'bundle');

// Sort bundles by extracting the number from slug (bundle-1, bundle-2, bundle-3)
// and transform image objects to URLs
const sortedBundles = [...bundles]
  .sort((a, b) => {
    const numA = parseInt(a.slug.current.replace(/\D/g, ''), 10) || 0;
    const numB = parseInt(b.slug.current.replace(/\D/g, ''), 10) || 0;
    return numA - numB;
  })
  .map((bundle) => ({
    ...bundle,
    wineDiscounts: (bundle.wineDiscounts ?? []).map((w) => ({
      ...w,
      image: w.image ? urlFor(w.image)?.width(120).height(180).url() : undefined,
    })),
  }));

// Map bundle slugs to icons (support both old and new naming)
const bundleIcons: Record<string, ImageMetadata> = {
  'bundle-1': bronze,
  'bundle-2': silver,
  'bundle-3': gold,
};
---

<Layout title="Shop | Nextaz">
  <!-- Hero Section -->
  <section
    id="shop-hero"
    class="bg-gray-light flex flex-col overflow-hidden px-0 pt-32 lg:h-[1080px] lg:flex-row lg:px-30 lg:pt-10"
  >
    <div
      class="order-2 flex flex-col items-center justify-center text-center lg:order-0 lg:w-[700px] lg:shrink-0 lg:items-start lg:text-left"
    >
      <h1 class="mb-4 text-5xl leading-none font-bold lg:mb-12 lg:text-9xl">Shop</h1>
      <h2 class="mb-6 text-2xl leading-none font-bold lg:text-5xl">Alege vinul tău preferat</h2>
      <p
        class="text-gray-dark mb-50 max-w-[600px] px-6 text-lg leading-relaxed lg:px-0 lg:text-xl lg:text-black"
      >
        Descoperă gama Nextaz și comandă vinuri pentru acasă, cadouri, petreceri sau evenimente
        speciale.
      </p>
    </div>
    <div
      class="flex h-[60vh] w-full items-center justify-center lg:-ml-[400px] lg:h-auto lg:w-[1600px] lg:justify-start"
    >
      <Image
        src={heroImage}
        alt="Vinuri Nextaz - selecție de vinuri albe și rosé"
        class="h-full w-full object-cover object-center lg:origin-left lg:scale-120 lg:object-left"
      />
    </div>
  </section>

  <!-- Products Section -->
  <section id="products" class="bg-white px-6 pb-16 lg:px-30 lg:pb-24">
    {
      singleProducts.length > 0 && (
        <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
          {singleProducts.map((product, index) => (
            <div
              class={
                index < 2 ? `z-elevated relative lg:-mt-16 ${index === 0 ? '-mt-12' : ''}` : ''
              }
            >
              <SingleProductCard product={product} />
            </div>
          ))}
        </div>
      )
    }

    {
      packages.length > 0 && (
        <div class="mt-4 flex flex-col gap-6 lg:gap-8">
          {packages.map((product) => (
            <div class="w-full">
              <PackageProductCard product={product} />
            </div>
          ))}
        </div>
      )
    }

    {
      sortedBundles.length > 0 && (
        <>
          <div class="mt-4 flex flex-col gap-4 lg:hidden">
            {sortedBundles.map((bundle) => {
              const icon = bundleIcons[bundle.slug.current as keyof typeof bundleIcons];
              return (
                <div class="product-card">
                  <BundleCard bundle={bundle} icon={icon} />
                </div>
              );
            })}
          </div>

          {/* Desktop */}
          <div class="mt-4 hidden lg:block">
            <div class="product-card flex flex-row">
              {sortedBundles.map((bundle, index) => {
                const icon = bundleIcons[bundle.slug.current as keyof typeof bundleIcons];
                const isLast = index === sortedBundles.length - 1;
                return (
                  <div class="relative flex-1">
                    <BundleCard bundle={bundle} icon={icon} />
                    {!isLast && <div class="absolute top-[10%] right-0 h-[80%] w-px bg-gray-200" />}
                  </div>
                );
              })}
            </div>
          </div>
        </>
      )
    }

    {/* Special Products - Custom Bundle & Subscription */}
    <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
      {/* Custom Bundle Card */}
      <article class="product-card flex-col lg:py-12">
        <div class="flex h-[220px] w-full items-end justify-center overflow-hidden pb-4 lg:h-[260px]">
          <div class="relative flex items-end">
            <Image
              src={triangle}
              alt=""
              class="h-[150px] w-auto object-contain lg:h-[200px]"
              aria-hidden="true"
            />
            <Image
              src={barrels}
              alt="Bundle personalizat"
              class="-ml-8 h-[150px] w-auto object-contain lg:-ml-10 lg:h-[200px]"
            />
          </div>
        </div>
        <div class="flex flex-col items-center gap-4 p-6 text-center lg:gap-6 lg:px-8 lg:pt-8">
          <h3 class="text-xl font-bold text-black">Bundle personalizat</h3>
          <p class="text-gray text-base max-w-[300px] min-h-13 leading-relaxed">
            Ai nevoie de o cantitate personalizată sau o selecție specială? Te ajutăm.
          </p>
          <p class="text-lg font-bold text-black">
            40,00 lei
          </p>
          <a href="/contact" class="btn-add-to-cart">Contactează-ne</a>
        </div>
      </article>

      {/* Subscription Card */}
      <article class="product-card flex-col lg:py-12">
        <div class="flex h-[220px] w-full items-end justify-center overflow-hidden pb-4 lg:h-[260px]">
          <div class="relative flex items-end">
            <Image
              src={triangle}
              alt=""
              class="h-[150px] w-auto object-contain lg:h-[200px]"
              aria-hidden="true"
            />
            <Image
              src={notebook}
              alt="Abonament lunar"
              class="-ml-8 h-[150px] w-auto object-contain lg:-ml-5 lg:h-[200px]"
            />
          </div>
        </div>
        <div class="flex flex-col items-center gap-4 p-6 text-center lg:gap-6 lg:px-8 lg:pt-8">
          <h3 class="text-xl font-bold text-black">Abonament lunar</h3>
          <p class="text-gray text-base min-h-13 leading-relaxed">
            Primești vinurile preferate în fiecare lună
          </p>
          <p class="text-lg font-bold text-black">
            40,00 lei
          </p>
          <AddToCartButton
            client:visible
            productId="subscription"
            productName="Abonament lunar"
            productPrice={subscriptionPrice}
            itemType="subscription"
          />
        </div>
      </article>
    </div>
  </section>

  <!-- Bundle Configurator Modal -->
  <BundleConfigurator client:load />
</Layout>
