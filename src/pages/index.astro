---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import { MuxPlayer } from '@mux/mux-player-astro';
import Layout from '../layouts/Layout.astro';
import allWines from '../assets/all-wines.png';
import allWinesMobile from '../assets/all-wines-mobile.png';
import gallerySample from '../assets/gallery-sample.png';
import arrowUp from '../assets/arrow-up.svg';
import close from '../assets/close.svg';
import culinarySign from '../assets/culinary-sign.svg';
import flower from '../assets/flower.svg';
import glass from '../assets/glass.svg';
import hexagon from '../assets/hexagon.svg';
import leaf from '../assets/leaf.svg';
import lemonFlavour from '../assets/lemon-flavour.svg';

// Dynamic image imports for wine bottles
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/bottle-*.png', { eager: true });

// Wine type with resolved image
type Wine = {
  order: number;
  id: string;
  image: ImageMetadata;
  title: string;
  description: string;
  flavours: string[];
  organoleptic: string[];
  culinary: string[];
};

const wineEntries = await getCollection('wines');
const wines: Wine[] = wineEntries
  .sort((a, b) => a.data.order - b.data.order)
  .map((entry) => {
    const imagePath = `/src/assets/${entry.data.image}`;
    const imageModule = images[imagePath];
    if (!imageModule) {
      throw new Error(`Image not found: ${imagePath}`);
    }
    return {
      ...entry.data,
      image: imageModule.default,
    };
  });
---

<Layout title="Nextaz">
  <div class="flex min-h-screen flex-col items-center">
    <div class="inset-0 h-full w-full">
      <Image src={allWinesMobile} class="block lg:hidden w-full object-cover" loading="eager" alt="All Wines" />
      <Image src={allWines} class="hidden lg:block w-full object-cover" loading="eager" alt="All Wines" />
    </div>

    <div class="flex w-full flex-col items-center py-18 lg:flex-row lg:justify-evenly lg:py-40">
      <div class="flex">
        <div
          class="h-[36vw] max-h-175 min-h-88 w-[25vw] max-w-105 min-w-53 lg:min-h-116 lg:min-w-70"
          style="clip-path: polygon(0 0, 100% 50%, 0 100%);"
        >
          <MuxPlayer
            playbackId="HjiJrWEuFT95bsSTMhW8NDP8Zad4gszfcYcUHOUSLzk"
            metadata={{ video_title: 'wine bubbles' }}
            streamType="on-demand"
            autoplay
            muted
            loop
            nohotkeys
            class="h-full w-full"
            style={{
              '--controls': 'none',
              '--media-object-fit': 'cover',
              '--media-object-position': 'center',
            }}
          />
        </div>
        <div
          class="h-[36vw] max-h-175 min-h-88 w-[9vw] max-w-45 min-w-23 bg-black lg:min-h-116 lg:min-w-31"
        >
        </div>
      </div>
      <div class="mx-[2vw] mt-25 flex h-full min-h-140 w-95 flex-col justify-between lg:mt-0">
        {
          [
            {
              icon: leaf,
              text: 'Vinuri moderne create pentru un stil de viață tânăr și relaxat.',
            },
            {
              icon: hexagon,
              text: 'Soiuri locale reinterpretate într-un profil fresh și ușor de savurat.',
            },
            {
              icon: glass,
              text: 'Perfecte pentru terase, seri cu prietenii și momente fără complicații.',
            },
          ].map(({ icon, text }) => (
            <div class="flex flex-col items-center lg:items-start">
              <Image src={icon} alt="Wine Icon" />
              <p class="mt-4 text-center text-xl/loose lg:text-left">{text}</p>
            </div>
          ))
        }
      </div>
    </div>
    <h2 class="mb-30 text-[3.25rem] font-bold">Gama Nextaz</h2>
    <div class="wine-cells-container relative flex w-full flex-row flex-wrap">
      {
        wines.map(({ id, image, title, description, flavours, organoleptic, culinary }) => (
          <div
            data-wine-id={id}
            class="wine-cell group bg-gray-light hover:bg-gray-lighter aria-expanded:hover:bg-gray-light hidden aspect-auto w-full cursor-pointer overflow-hidden border border-white transition-all duration-500 lg:flex lg:aspect-square lg:w-1/2 relative"
            aria-expanded="false"
          >
            <button class="absolute top-0 right-0 flex items-center justify-center opacity-0 transition-all duration-300 group-aria-expanded:opacity-100 w-12 h-12 cursor-pointer">
              <Image src={close} alt="Close" />
            </button>
            <div class="flex h-full w-full flex-col px-[1.7vw] py-[2.5vw]">
              <div class="flex h-full flex-col lg:flex-row">
                <div class="flex h-[50vw] w-full flex-col items-center justify-between transition-all duration-500">
                  <Image
                    src={image}
                    alt={title}
                    class="h-auto w-70 transition-transform duration-500 group-hover:scale-115 group-aria-expanded:group-hover:scale-100 lg:w-[20vw]"
                    loading="eager"
                  />
                  <h3 class="mb-2 text-center text-3xl font-bold">{title}</h3>
                  <p class="mb-2 max-w-sm text-center text-xl">{description}</p>
                  <button class="text-gray group-aria-expanded:group-hover:text-gray text-base underline transition-all duration-500 group-hover:scale-115 group-hover:text-black group-aria-expanded:scale-0 group-aria-expanded:opacity-0 group-aria-expanded:hover:scale-0">
                    Vezi detalii
                  </button>
                  <a
                    href="/shop"
                    class="btn-add-to-cart scale-0 text-lg opacity-0 transition-all duration-500 group-aria-expanded:scale-100 group-aria-expanded:opacity-100 lg:text-2xl"
                  >
                    Comandă
                  </a>
                </div>
                <div class="flex h-[0%] w-[0%] flex-col gap-[4.5vw] overflow-hidden transition-all duration-500 group-aria-expanded:h-full group-aria-expanded:w-[250%]">
                  <div class="mt-[2.5vw] flex flex-col gap-[4.5vw] lg:mt-[5vw] lg:flex-row">
                    <div>
                      <h4 class="mb-2 flex flex-row items-center text-3xl font-bold">
                        <Image src={lemonFlavour} alt="Profil aromatic" class="mr-3" />
                        Profil aromatic
                      </h4>
                      <ul class="text-gray-dark ml-25 list-disc pl-5 text-lg lg:text-xl">
                        {flavours.map((flavour) => (
                          <li>{flavour}</li>
                        ))}
                      </ul>
                    </div>
                    <div>
                      <h4 class="mb-2 flex flex-row items-center text-3xl font-bold">
                        <Image src={flower} alt="Caracteristici organoleptice" class="mx-6 my-4" />
                        Caracteristici organoleptice
                      </h4>
                      <ul class="text-gray-dark ml-25 list-disc pl-5 text-lg lg:text-xl">
                        {organoleptic.map((item) => (
                          <li>{item}</li>
                        ))}
                      </ul>
                    </div>
                  </div>
                  <div>
                    <h4 class="mb-2 flex flex-row items-center text-3xl font-bold">
                      <Image src={culinarySign} alt="Recomandări culinare" class="mx-5 my-5" />
                      Recomandări culinare
                    </h4>
                    <ul class="text-gray-dark ml-25 list-disc pl-5 text-lg lg:text-xl">
                      {culinary.map((item) => (
                        <li>{item}</li>
                      ))}
                    </ul>
                  </div>
                </div>
              </div>
              <div class="h-[0%] w-[0%] overflow-hidden transition-all duration-500 group-aria-expanded:h-full group-aria-expanded:w-full">
                <div class="p-[4vw]">
                  <h4 class="text-center text-3xl font-bold">Galerie</h4>
                  <div class="mt-23 flex justify-center gap-18 overflow-auto">
                    {[gallerySample, gallerySample, gallerySample, gallerySample].map((image) => (
                      <Image
                        src={image}
                        alt="Gallery Sample"
                        class="h-[29vw] w-[17vw] object-cover"
                        loading="eager"
                      />
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            data-wine-id={`${id}-mobile`}
            class="wine-cell-mobile relative group flex w-full cursor-pointer flex-col border border-white bg-gray-light transition-all duration-500 lg:hidden"
            aria-expanded="false"
          >
            <button class="absolute top-0 right-0 flex items-center justify-center opacity-0 transition-all duration-300 group-aria-expanded:opacity-100 w-10 h-10 cursor-pointer">
              <Image src={close} alt="Close" />
            </button>
            <div class="flex flex-col px-8 py-1">
              <div class="flex flex-col items-center">
                <Image
                  src={image}
                  alt={title}
                  class="mb-6 h-auto w-70"
                  loading="eager"
                />
                <h3 class="mb-2 text-center text-2xl font-bold">{title}</h3>
                <p class="mb-4 max-w-[70vw] text-center text-[1rem]">{description}</p>
                <button class="text-gray my-5 text-base underline opacity-100 scale-100 transition-all duration-300 delay-300 group-aria-expanded:opacity-0 group-aria-expanded:scale-0 group-aria-expanded:delay-0">
                  Vezi detalii
                </button>
              </div>

              {/* Expanded content */}
              <div class="max-h-0 overflow-hidden opacity-0 transition-all duration-1000 ease-in-out group-aria-expanded:max-h-[3000px] group-aria-expanded:opacity-100">
                <div class="flex flex-col items-center gap-8">
                  <a href="/shop" class="btn-add-to-cart text-center text-lg m-auto">
                    Comandă
                  </a>
                  <div>
                    <h4 class="mb-3 flex flex-col items-center text-[1.375rem] font-bold">
                      <Image src={lemonFlavour} alt="Profil aromatic" class="h-13 w-13" />
                      Profil aromatic
                    </h4>
                    <ul class="text-gray-dark ml-8 list-disc pl-5 text-sm/loose">
                      {flavours.map((flavour) => (
                        <li>{flavour}</li>
                      ))}
                    </ul>
                  </div>

                  <div>
                    <h4 class="mb-3 flex flex-col items-center text-[1.375rem] font-bold">
                      <Image src={flower} alt="Caracteristici organoleptice" class="mb-2 h-8 w-8" />
                      Caracteristici organoleptice
                    </h4>
                    <ul class="text-gray-dark ml-8 list-disc pl-5 text-sm/loose">
                      {organoleptic.map((item) => (
                        <li>{item}</li>
                      ))}
                    </ul>
                  </div>

                  <div>
                    <h4 class="mb-3 flex flex-col items-center text-[1.375rem] font-bold">
                      <Image src={culinarySign} alt="Recomandări culinare" class="mb-2 h-9 w-9" />
                      Recomandări culinare
                    </h4>
                    <ul class="text-gray-dark ml-8 list-disc pl-5 text-sm/loose">
                      {culinary.map((item) => (
                        <li>{item}</li>
                      ))}
                    </ul>
                  </div>

                  <div>
                    <div class="relative">
                      <div
                        class="gallery-carousel overflow-hidden"
                        data-wine-id={`${id}-gallery`}
                      >
                        <div class="gallery-track flex transition-transform duration-300 ease-out">
                          {[gallerySample, gallerySample, gallerySample, gallerySample].map((galleryImage, index) => (
                            <div class="w-full shrink-0">
                              <Image
                                src={galleryImage}
                                alt={`Gallery ${index + 1}`}
                                class="mx-auto h-auto w-[80vw] object-cover"
                                loading="eager"
                              />
                            </div>
                          ))}
                        </div>
                      </div>
                      <div class="mt-6 flex justify-center gap-2">
                        {[gallerySample, gallerySample, gallerySample, gallerySample].map((_, index) => (
                          <button
                            class={`gallery-dot h-2 w-2 rounded-full transition-all duration-300 ${index === 0 ? 'bg-black' : 'bg-gray'}`}
                            data-index={index}
                            aria-label={`Go to image ${index + 1}`}
                          />
                        ))}
                      </div>
                    </div>
                  </div>
                  <a href="/shop" class="btn-add-to-cart my-4 text-center text-lg mx-auto">
                      Comandă
                  </a>
                </div>
                <button class="flex items-center justify-centerw-10 h-10 cursor-pointer m-auto">
                  <Image src={arrowUp} alt="Close" />
                </button>
              </div>
            </div>
          </div>
        ))
      }
    </div>
    <div
      id="command-modal"
      class="absolute top-75 flex w-80 translate-y-80 flex-col items-center border border-white/30 bg-white/1 px-7 py-10 opacity-0 shadow-2xl backdrop-blur-sm transition-all duration-1000 lg:w-160 lg:px-13 lg:py-16"
    >
      <h2 class="mb-4 text-center text-3xl leading-8 font-bold lg:text-[3.25rem] lg:leading-12">
        Pentru momentele<br />ce vin.
      </h2>
      <p class="mb-6 text-center text-lg lg:text-2xl">
        Eleganță, și autenticitate, create pentru momentele în care vrei să fie bine.
      </p>
      <a href="/shop" class="btn-add-to-cart text-lg lg:text-2xl"> Comandă </a>
    </div>
  </div>
</Layout>

<script>
  function revealModal() {
    const modal = document.getElementById('command-modal');
    if (!modal) return;
    setTimeout(() => {
      modal.classList.remove('opacity-0', 'translate-y-80');
      modal.classList.add('opacity-100', 'translate-y-0');
    }, 1000);
  }

  function initWineCells() {
    const container = document.querySelector('.wine-cells-container');
    if (!container) return;

    // Desktop cells
    const cells = container.querySelectorAll('.wine-cell');
    let expandedCell: Element | null = null;

    cells.forEach((cell) => {
      cell.addEventListener('click', (_) => {
        const otherCells = Array.from(cells).filter((c) => c !== cell) as HTMLElement[];

        if (expandedCell === cell) {
          collapseCell(cell, otherCells);
          expandedCell = null;
          return;
        }

        // Expand this cell
        expandCell(cell as HTMLElement, otherCells);
        expandedCell = cell;

        setTimeout(() => {
          const headerOffset = 80; // Adjust this value for your header height
          const containerTop = container.getBoundingClientRect().top + window.scrollY;
          window.scrollTo({
            top: containerTop - headerOffset,
            behavior: 'smooth',
          });
        });
      });
    });

    function expandCell(cell: HTMLElement, otherCells: HTMLElement[]) {
      cell.setAttribute('aria-expanded', 'true');

      cell.classList.remove('lg:w-1/2');

      requestAnimationFrame(() => {
        otherCells.forEach((otherCell) => {
          otherCell.style.opacity = '0';
          otherCell.style.width = '0%';
          otherCell.style.height = '0%';
        });
      });
    }

    function collapseCell(cell: Element, otherCells: HTMLElement[]) {
      cell.classList.add('lg:w-1/2');

      otherCells.forEach((otherCell) => {
        otherCell.style.opacity = '1';
        otherCell.style.removeProperty('width');
        otherCell.style.removeProperty('height');
      });

      cell.setAttribute('aria-expanded', 'false');
    }

    // Mobile cells - simpler logic, no hiding other cells
    const mobileCells = container.querySelectorAll('.wine-cell-mobile');

    mobileCells.forEach((cell) => {
      cell.addEventListener('click', (e) => {
        // Don't toggle if clicking on gallery controls
        if ((e.target as HTMLElement).closest('.gallery-carousel, .gallery-dot')) {
          return;
        }
        const isExpanded = cell.getAttribute('aria-expanded') === 'true';
        cell.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
      });
    });
  }

  function initGalleryCarousels() {
    const carousels = document.querySelectorAll('.gallery-carousel');

    carousels.forEach((carousel) => {
      const track = carousel.querySelector('.gallery-track') as HTMLElement;
      const dots = carousel.parentElement?.querySelectorAll('.gallery-dot') as NodeListOf<HTMLElement>;
      if (!track || !dots) return;

      let currentIndex = 0;
      const totalImages = dots.length;
      let touchStartX = 0;
      let touchEndX = 0;

      function updateCarousel(index: number) {
        currentIndex = index;
        track.style.transform = `translateX(-${currentIndex * 100}%)`;

        // Update dots
        dots.forEach((dot, i) => {
          if (i === currentIndex) {
            dot.classList.add('bg-black');
            dot.classList.remove('bg-gray');
          } else {
            dot.classList.remove('bg-black');
            dot.classList.add('bg-gray');
          }
        });
      }

      // Touch events for swipe
      carousel.addEventListener('touchstart', (e) => {
        touchStartX = (e as TouchEvent).touches[0].clientX;
      });

      carousel.addEventListener('touchend', (e) => {
        touchEndX = (e as TouchEvent).changedTouches[0].clientX;
        handleSwipe();
      });

      function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0 && currentIndex < totalImages - 1) {
            updateCarousel(currentIndex + 1);
          } else if (diff < 0 && currentIndex > 0) {
            updateCarousel(currentIndex - 1);
          }
        }
      }

      // Dot click events
      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          updateCarousel(index);
        });
      });
    });
  }

  document.addEventListener('astro:page-load', () => {
    revealModal();
    initWineCells();
    initGalleryCarousels();
  });
</script>
